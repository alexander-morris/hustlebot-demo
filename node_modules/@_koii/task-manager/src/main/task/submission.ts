import { namespaceWrapper } from "@_koii/namespace-wrapper";
import { getTaskManager } from "../taskManager.js";

class Submission {
  /**
   * Submits a task for a given round
   *
   */
  async submitTask(round: number): Promise<string | void> {
    console.log("SUBMIT TASK CALLED ROUND NUMBER", round);
    try {
      console.log("SUBMIT TASK SLOT", await namespaceWrapper.getSlot());
      const taskManager = await getTaskManager();
      const submission = await taskManager.fetchSubmission(round);
      if (!(typeof submission === "string")) {
        return;
      }
      const byteLength = Buffer.byteLength(submission, "utf8");
      if (byteLength > 512) {
        throw new Error("Submission exceeds 512 bytes");
      }
      console.log("SUBMISSION", submission);
      await namespaceWrapper.checkSubmissionAndUpdateRound(submission, round);
      console.log("SUBMISSION CHECKED AND ROUND UPDATED");
      return submission;
    } catch (error) {
      console.log("ERROR IN SUBMISSION", error);
    }
  }
}

export const submission = new Submission();

// required to use local staking wallet during testing in namespaceWrapper
import dotenv from "dotenv";
dotenv.config();
import { taskNodeAdministered, app } from "@_koii/namespace-wrapper";

import { setupTask } from "./task/setup.js";
import { getTaskManager } from "./taskManager.js";
export { getTaskManager, initializeTaskManager } from "./taskManager.js";
export { coreLogic as taskRunner } from "./task/coreLogic.js";
export type { Submitter, DistributionList } from "../types/global.js";

async function startTask() {
  if (taskNodeAdministered) {
    await setupTask();
  }
  const taskManager = await getTaskManager();
  await taskManager.customSetup();
  console.log("after custom setup");
  if (!taskNodeAdministered) {
    app.use((req, _res, next) => {
        const directories = req.url.split("/");
        req.url = `/${directories.slice(3).join("/")}`;
      next();
    });
  }
  await taskManager.setupRoutes();
}

startTask();
